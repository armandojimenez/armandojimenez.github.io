/**
 * Policy Pages JavaScript
 * Handles theme switching, smooth scrolling, interactions, and localization
 */

'use strict';

(function () {
    'use strict';

    // ===========================
    // Localization Management
    // ===========================
    var SUPPORTED_LANGUAGES = ['en', 'es'];
    var DEFAULT_LANGUAGE = 'en';

    // Get language from URL parameter or default to English
    function getLanguage() {
        var urlParams = new URLSearchParams(window.location.search);
        var lang = urlParams.get('lang');

        // If language is supported, use it; otherwise default to English
        if (lang && SUPPORTED_LANGUAGES.includes(lang.toLowerCase())) {
            return lang.toLowerCase();
        }

        return DEFAULT_LANGUAGE;
    }

    // Set HTML lang attribute
    var currentLanguage = getLanguage();
    document.documentElement.setAttribute('lang', currentLanguage);

    // Store current language globally for dynamic content
    window.currentLanguage = currentLanguage;

    // ===========================
    // Theme Management
    // ===========================
    var themeToggle = document.getElementById('themeToggle');
    var html = document.documentElement;

    // Get theme from URL parameter, localStorage, or system preference
    function getPreferredTheme() {
        // Check for URL parameter first (e.g., ?theme=dark or ?theme=light)
        var urlParams = new URLSearchParams(window.location.search);
        var themeParam = urlParams.get('theme');
        if (themeParam === 'dark' || themeParam === 'light') {
            return themeParam;
        }

        // Then check localStorage
        var savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            return savedTheme;
        }

        // Finally, use system preference
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    // Set theme
    function setTheme(theme) {
        html.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    }

    // Initialize theme
    var currentTheme = getPreferredTheme();
    setTheme(currentTheme);

    // Theme toggle handler
    if (themeToggle) {
        themeToggle.addEventListener('click', function () {
            var currentTheme = html.getAttribute('data-theme');
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);

            // Add animation class
            themeToggle.style.transform = 'rotate(360deg)';
            setTimeout(function () {
                themeToggle.style.transform = '';
            }, 300);
        });
    }

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
        if (!localStorage.getItem('theme')) {
            setTheme(e.matches ? 'dark' : 'light');
        }
    });

    // ===========================
    // Smooth Scroll for TOC Links
    // ===========================
    var tocLinks = document.querySelectorAll('.toc-list a');

    tocLinks.forEach(function (link) {
        link.addEventListener('click', function (e) {
            e.preventDefault();
            var targetId = link.getAttribute('href');
            var targetSection = document.querySelector(targetId);

            if (targetSection) {
                var offset = 80; // Offset for fixed elements
                var targetPosition = targetSection.getBoundingClientRect().top + window.pageYOffset - offset;

                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });

                // Update active link
                updateActiveTOCLink(link);
            }
        });
    });

    // ===========================
    // Active TOC Link Highlighting
    // ===========================
    function updateActiveTOCLink(activeLink) {
        tocLinks.forEach(function (link) {
            link.style.color = '';
            link.style.fontWeight = '';
        });

        if (activeLink) {
            activeLink.style.color = 'var(--accent-primary)';
            activeLink.style.fontWeight = '600';
        }
    }

    // Intersection Observer for active section detection
    var sections = document.querySelectorAll('.policy-section');
    var observerOptions = {
        root: null,
        rootMargin: '-20% 0px -70% 0px',
        threshold: 0
    };

    var sectionObserver = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
            if (entry.isIntersecting) {
                var id = entry.target.getAttribute('id');
                var correspondingLink = document.querySelector('.toc-list a[href="#' + id + '"]');
                updateActiveTOCLink(correspondingLink);
            }
        });
    }, observerOptions);

    sections.forEach(function (section) {
        sectionObserver.observe(section);
    });

    // ===========================
    // Back to Top Functionality
    // ===========================
    var backToTopButton = undefined;

    function createBackToTopButton() {
        backToTopButton = document.createElement('button');
        backToTopButton.innerHTML = '↑';
        backToTopButton.className = 'back-to-top';
        backToTopButton.setAttribute('aria-label', 'Back to top');
        backToTopButton.style.cssText = '\n            position: fixed;\n            bottom: 2rem;\n            right: 2rem;\n            width: 48px;\n            height: 48px;\n            border-radius: 50%;\n            background: var(--accent-primary);\n            color: white;\n            border: none;\n            font-size: 1.5rem;\n            cursor: pointer;\n            opacity: 0;\n            visibility: hidden;\n            transition: all 0.3s ease;\n            box-shadow: var(--shadow-lg);\n            z-index: 999;\n        ';

        document.body.appendChild(backToTopButton);

        backToTopButton.addEventListener('click', function () {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }

    createBackToTopButton();

    // Show/hide back to top button
    window.addEventListener('scroll', function () {
        if (window.pageYOffset > 300) {
            backToTopButton.style.opacity = '1';
            backToTopButton.style.visibility = 'visible';
        } else {
            backToTopButton.style.opacity = '0';
            backToTopButton.style.visibility = 'hidden';
        }
    });

    // ===========================
    // External Links
    // ===========================
    var externalLinks = document.querySelectorAll('a[target="_blank"]');
    externalLinks.forEach(function (link) {
        link.setAttribute('rel', 'noopener noreferrer');
    });

    // ===========================
    // Print Optimization
    // ===========================
    window.addEventListener('beforeprint', function () {
        // Expand all collapsed sections if any
        console.log('Preparing page for print...');
    });

    // ===========================
    // Performance Monitoring
    // ===========================
    if ('performance' in window) {
        window.addEventListener('load', function () {
            var perfData = performance.getEntriesByType('navigation')[0];
            if (perfData) {
                console.log('Page Load Time:', Math.round(perfData.loadEventEnd - perfData.fetchStart), 'ms');
            }
        });
    }

    // ===========================
    // Copy to Clipboard (for code blocks if any)
    // ===========================
    function addCopyButtons() {
        var codeBlocks = document.querySelectorAll('pre code');
        codeBlocks.forEach(function (block) {
            var button = document.createElement('button');
            button.textContent = 'Copy';
            button.style.cssText = '\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                padding: 4px 12px;\n                font-size: 0.85rem;\n                background: var(--accent-primary);\n                color: white;\n                border: none;\n                border-radius: 4px;\n                cursor: pointer;\n            ';

            var pre = block.parentElement;
            pre.style.position = 'relative';
            pre.appendChild(button);

            button.addEventListener('click', function () {
                navigator.clipboard.writeText(block.textContent).then(function () {
                    button.textContent = 'Copied!';
                    setTimeout(function () {
                        button.textContent = 'Copy';
                    }, 2000);
                });
            });
        });
    }

    addCopyButtons();

    // ===========================
    // Language Switcher
    // ===========================
    function createLanguageSwitcher() {
        var languageSwitcher = document.getElementById('languageSwitcher');
        if (!languageSwitcher) return;

        var languages = {
            'en': 'English',
            'es': 'Español'
        };

        // Create language buttons
        Object.keys(languages).forEach(function (lang) {
            var button = document.createElement('button');
            button.className = 'lang-button';
            button.textContent = languages[lang];
            button.setAttribute('data-lang', lang);

            // Mark current language as active
            if (lang === currentLanguage) {
                button.classList.add('active');
            }

            // Switch language on click
            button.addEventListener('click', function () {
                var urlParams = new URLSearchParams(window.location.search);
                urlParams.set('lang', lang);
                window.location.search = urlParams.toString();
            });

            languageSwitcher.appendChild(button);
        });
    }

    // Initialize language switcher when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createLanguageSwitcher);
    } else {
        createLanguageSwitcher();
    }

    // ===========================
    // Keyboard Navigation
    // ===========================
    document.addEventListener('keydown', function (e) {
        // Escape key closes modals or returns to top
        if (e.key === 'Escape') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });

    // ===========================
    // Loading Animation Complete
    // ===========================
    document.body.style.opacity = '0';
    window.addEventListener('load', function () {
        document.body.style.transition = 'opacity 0.3s ease';
        document.body.style.opacity = '1';
    });
})();
